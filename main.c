//------------------------------------------------
// Name: oled-display.c
//
// Created: 15.02.2021 18:44:51
// Author : Filip Bartoš
// Websites used as reference:
/* https://embedds.com/programming-avr-i2c-interface/
 * https://www.hwkitchen.cz/user/related_files/graficky-displej-oled-096-128x64-i2c-datasheet.pdf
 * https://www.avrfreaks.net/forum/solved-i2c-ssd1306-display
 * https://github.com/efthymios-ks/AVR-TWI
 * https://electronics.stackexchange.com/questions/273634/atmega328-i2c-twi-and-oled-display/337912
 * https://github.com/Sylaina/oled-display/blob/master/i2c.c
 * https://ww1.microchip.com/downloads/en/DeviceDoc/Atmel-2486-8-bit-AVR-microcontroller-ATmega8_L_datasheet.pdf
 * https://github.com/tibounise/SSD1306-AVR
 * https://www.nongnu.org/avr-libc/user-manual/pgmspace.html
*/
//------------------------------------------------

#define F_CPU 16000000UL

#include <avr/io.h>
#include <avr/pgmspace.h>
#include "s_TWI.h"
#include "SSD1306.h"

//Image stored in program memory
const uint8_t display_buffer[1024] PROGMEM = {
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xE0, 0xF0, 0x7C, 0x1E, 0x0F, 0x07, 0x03, 0x07, 0x06,
	0x0E, 0x1C, 0x78, 0xF0, 0xC0, 0x00, 0x00, 0x00, 0x01, 0x1F, 0x7F, 0xF8, 0xC0, 0x00, 0x00, 0x00,
	0x00, 0xC0, 0xE7, 0x7F, 0x3E, 0x7F, 0xF3, 0xC0, 0x80, 0x00, 0x00, 0x80, 0xE0, 0xF8, 0x3C, 0x0E,
	0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0xE0, 0xFC, 0xFE, 0xFE, 0x80, 0x00, 0x00, 0x00, 0xC0, 0xE0,
	0x78, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xE0, 0xE0, 0xB0, 0x18, 0x08, 0x0C, 0x06,
	0x02, 0x02, 0x1F, 0x37, 0xE1, 0x49, 0x05, 0x91, 0x03, 0x11, 0x81, 0x0B, 0x01, 0x9D, 0x37, 0xE3,
	0x02, 0x02, 0x02, 0x02, 0x06, 0x04, 0x74, 0xB4, 0xDC, 0x58, 0xE8, 0x58, 0x30, 0x60, 0xC0, 0x80,
	0x80, 0xC0, 0xE0, 0x70, 0x30, 0x30, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x7F, 0xF0,
	0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x7F, 0xF8, 0xE0, 0xC0, 0x80, 0x80, 0x80, 0x80,
	0x80, 0xC0, 0xF0, 0x7F, 0x1F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x0F, 0x3F, 0x38, 0x1C,
	0x07, 0x03, 0x01, 0x00, 0x00, 0x00, 0x01, 0x03, 0x07, 0x06, 0x07, 0x03, 0x01, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x1E, 0x1F, 0x07, 0x01, 0x01, 0x0F, 0x7F, 0x78, 0x3E, 0x0F, 0x03, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFC, 0xAF, 0x65, 0xAB, 0xBA, 0xA5, 0x5F, 0x70, 0xC0, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x03, 0x9F, 0xF0, 0xC0, 0x8C, 0x90, 0x80, 0x80, 0x88, 0xA0, 0xDE, 0x73,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF8, 0x4F, 0xBB, 0x5C, 0x63, 0x49, 0x2D, 0xF3, 0x1C, 0x07,
	0x07, 0x1F, 0x78, 0x60, 0xE0, 0xC0, 0xC0, 0x80, 0x80, 0xC0, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x03,
	0x0F, 0x1C, 0x18, 0x1C, 0x0E, 0x07, 0x03, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
	0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xFF, 0x36, 0xF8, 0x8D, 0x06, 0x07, 0x67, 0x77,
	0x35, 0x05, 0x85, 0x8D, 0xD9, 0x71, 0x30, 0x78, 0x4C, 0xC4, 0x84, 0x86, 0xB2, 0x3A, 0x1B, 0x03,
	0x87, 0x85, 0xEF, 0x3A, 0x02, 0x07, 0x05, 0x07, 0x0E, 0x09, 0x1F, 0x31, 0x3F, 0x61, 0xC0, 0x80,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0xE0, 0xF8, 0x3C,
	0x0E, 0x06, 0x06, 0x0E, 0x0C, 0x00, 0x00, 0x00, 0x00, 0xF0, 0xFE, 0x1E, 0x00, 0x00, 0x00, 0x00,
	0x03, 0x07, 0xF6, 0xFE, 0x3C, 0x1C, 0x38, 0x30, 0x00, 0x00, 0x00, 0x00, 0xF0, 0xF0, 0x00, 0x00,
	0x80, 0xC0, 0xE0, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x7F, 0x98, 0x91, 0xB1, 0x21, 0x61, 0x41,
	0x41, 0x41, 0x41, 0x40, 0x9E, 0xA1, 0xA1, 0xA1, 0xA1, 0xA1, 0x9E, 0x40, 0x41, 0x41, 0x21, 0xB1,
	0x11, 0x10, 0xA0, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x07, 0x0E,
	0x0C, 0x0C, 0x1C, 0x1C, 0x0C, 0x00, 0x00, 0x00, 0x1F, 0x1F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x70, 0x7F, 0x07, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xE0, 0xF8, 0x1F, 0x0F, 0x03,
	0x03, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0x60, 0x10, 0x30, 0x70,
	0xE0, 0xC0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x80, 0xC0, 0x60, 0x3F, 0x1E, 0x14, 0x35, 0x25, 0x25,
	0x2D, 0x69, 0xC9, 0x6A, 0x2A, 0x6A, 0x4A, 0xCA, 0x92, 0x92, 0x92, 0x8A, 0x89, 0xC9, 0x65, 0x24,
	0x22, 0x21, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x80,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0xE0,
	0x3F, 0x03, 0x01, 0x81, 0x83, 0x82, 0x82, 0xC7, 0x44, 0x44, 0x4C, 0x48, 0xF8, 0x88, 0x8C, 0xF4,
	0x9C, 0x0C, 0x0F, 0x08, 0x08, 0x18, 0x38, 0x2C, 0x27, 0x24, 0x24, 0x27, 0x3C, 0x18, 0x18, 0x10,
	0x10, 0x10, 0x1F, 0x89, 0x89, 0x89, 0x89, 0xC9, 0x49, 0x49, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x0C, 0x08, 0x0E, 0x07,
	0x02, 0x03, 0x01, 0x01, 0x00, 0x07, 0x1C, 0x70, 0xC0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01,
	0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
	0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};


void transfer_buffer()
{
	uint16_t i = 0;
	uint16_t j = 0;
	SSD1306_set_col_address();
	SSD1306_set_page_address();
	
	//Send buffer in 16 byte packets
	//1024 / 16 = 64 packets in total
	for(i = 0; i < 64; i++)
	{
		TWI_start(ADDRESS);
		TWI_write(0x40);
		for(j = 0; j < 16; j++)
		{
			TWI_write(pgm_read_byte(&(display_buffer[i*16+j])));
		}
		TWI_stop();
		j = 0;
	}
}

int main(void)
{
	//Set pins PB0 & PD7 to OUTPUT
	DDRB |= (1<<PB0);
	DDRD |= (1<<PD7);
	
	TWI_init();
	
	SSD1306_init();
	
	transfer_buffer();
	
	PORTD |= (1<<PD7);
	
}